# =============================================================================
# Bank GreenDrive â€” Docker Compose
# Supports: local development, staging, and production profiles
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Application server
  # ---------------------------------------------------------------------------
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: greendrive-app
    restart: unless-stopped
    ports:
      - '${PORT:-3001}:3001'
    env_file:
      - .env
    environment:
      - NODE_ENV=production
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=64m
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    mem_limit: 256m
    cpus: 0.5
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3001/']
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
        tag: 'greendrive-app'

  # ---------------------------------------------------------------------------
  # Reverse proxy (production profile)
  # ---------------------------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: greendrive-nginx
    restart: unless-stopped
    profiles:
      - production
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./deploy/nginx-greendrive.conf:/etc/nginx/conf.d/default.conf:ro
      - ./dist:/usr/share/nginx/html:ro
      - ./.well-known:/usr/share/nginx/html/.well-known:ro
      # Mount SSL certs in production
      # - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      app:
        condition: service_healthy
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETGID
      - SETUID
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid
      - /var/cache/nginx:noexec,nosuid
      - /var/run:noexec,nosuid
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '5'
        tag: 'greendrive-nginx'
