# =============================================================================
# Bank GreenDrive — Staging Deployment
# Auto-deploys on merge to develop; requires CI gate to pass
# =============================================================================

name: Deploy — Staging

on:
  workflow_run:
    workflows: ["CI — Quality & Security Gates"]
    types: [completed]
    branches: [develop]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-staging
  cancel-in-progress: false

jobs:
  # ---------------------------------------------------------------------------
  # Gate check — CI must have passed
  # ---------------------------------------------------------------------------
  verify-ci:
    name: Verify CI Passed
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # For workflow_run: only proceed when CI succeeded
    # For workflow_dispatch: always run (API check happens in step below)
    if: >-
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    outputs:
      deploy-sha: ${{ steps.resolve-sha.outputs.sha }}
    steps:
      - name: Resolve deployment SHA
        id: resolve-sha
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "sha=${{ github.event.workflow_run.head_sha }}" >> "$GITHUB_OUTPUT"
            echo "CI Gate passed — deploying ${{ github.event.workflow_run.head_sha }}"
          else
            echo "sha=${{ github.sha }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Verify CI Gate (manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              check_name: 'CI Gate',
            });
            const gate = checks.check_runs.find(c => c.name === 'CI Gate');
            if (!gate || gate.conclusion !== 'success') {
              core.setFailed('CI Gate has not passed — deployment blocked');
            }

  # ---------------------------------------------------------------------------
  # Deploy to staging
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [verify-ci]
    environment:
      name: staging
      url: https://staging-greendrive.middleleap.com
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.verify-ci.outputs.deploy-sha }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/staging.pem
          chmod 600 ~/.ssh/staging.pem
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts

      - name: Pre-deploy backup
        run: |
          ssh -i ~/.ssh/staging.pem ec2-user@${{ secrets.STAGING_HOST }} \
            "if [ -d ~/greendrive ]; then \
               BACKUP_DIR=~/backups/greendrive-staging-\$(date +%Y%m%d-%H%M%S); \
               mkdir -p ~/backups; \
               cp -r ~/greendrive/dist \$BACKUP_DIR 2>/dev/null || true; \
               echo \"Staging backup created: \$BACKUP_DIR\"; \
             fi"

      - name: Deploy via rsync
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.env' \
            --exclude '.env.*' \
            --exclude '.DS_Store' \
            --exclude '*.log' \
            --exclude 'keys/' \
            -e "ssh -i ~/.ssh/staging.pem" \
            ./ ec2-user@${{ secrets.STAGING_HOST }}:~/greendrive/

      - name: Install deps & restart
        run: |
          ssh -i ~/.ssh/staging.pem ec2-user@${{ secrets.STAGING_HOST }} \
            "cd ~/greendrive && \
             npm install --omit=dev && \
             (pm2 restart ecosystem.config.cjs --env production || pm2 start ecosystem.config.cjs --env production)"

      - name: Smoke test
        run: |
          sleep 10
          STATUS=$(ssh -i ~/.ssh/staging.pem ec2-user@${{ secrets.STAGING_HOST }} \
            "curl -sf http://localhost:3001/ | node -e \"process.stdin.on('data',d=>{const j=JSON.parse(d);console.log(j.status)})\"")
          if [ "$STATUS" != "ok" ]; then
            echo "::error::Smoke test FAILED — staging health check returned: $STATUS"
            exit 1
          fi
          echo "Smoke test PASSED — staging is healthy"
