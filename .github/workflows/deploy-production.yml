# =============================================================================
# Bank GreenDrive — Production Deployment
# Requires: manual approval, CI gate passed, staging verified
# Bank-grade: approval gates, rollback support, audit logging
# =============================================================================

name: Deploy — Production

on:
  workflow_run:
    workflows: ['CI — Quality & Security Gates']
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      rollback_sha:
        description: 'Commit SHA to roll back to (leave empty for latest)'
        required: false
        type: string
      skip_staging_check:
        description: 'Skip staging verification (emergency hotfix only)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  actions: read
  statuses: write

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  # ---------------------------------------------------------------------------
  # Gate check — CI must have passed
  # ---------------------------------------------------------------------------
  verify-ci:
    name: Verify CI Passed
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # For workflow_run: only proceed when CI succeeded
    # For workflow_dispatch: always run (API check happens in step below)
    if: >-
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    outputs:
      deploy-sha: ${{ steps.resolve-sha.outputs.sha }}
    steps:
      - name: Resolve deployment SHA
        id: resolve-sha
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "sha=${{ github.event.workflow_run.head_sha }}" >> "$GITHUB_OUTPUT"
            echo "CI Gate passed — deploying ${{ github.event.workflow_run.head_sha }}"
          else
            SHA="${{ inputs.rollback_sha }}"
            if [ -z "$SHA" ]; then
              SHA="${{ github.sha }}"
            fi
            echo "sha=$SHA" >> "$GITHUB_OUTPUT"
          fi

      - name: Verify CI Gate (manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v8
        with:
          script: |
            const ref = '${{ steps.resolve-sha.outputs.sha }}';
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: ref,
              check_name: 'CI Gate',
            });
            const gate = checks.check_runs.find(c => c.name === 'CI Gate');
            if (!gate || gate.conclusion !== 'success') {
              core.setFailed('CI Gate has not passed for this ref — deployment blocked');
            }
            core.info(`CI Gate passed for ${ref}`);

  # ---------------------------------------------------------------------------
  # Staging gate — ensure this SHA was deployed to staging first
  # ---------------------------------------------------------------------------
  verify-staging:
    name: Verify Staging Deployed
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [verify-ci]
    steps:
      - name: Check staging deployment (manual dispatch)
        if: >-
          github.event_name == 'workflow_dispatch' &&
          inputs.skip_staging_check != true
        uses: actions/github-script@v8
        with:
          script: |
            const sha = '${{ needs.verify-ci.outputs.deploy-sha }}';
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy-staging.yml',
              status: 'success',
              per_page: 20,
            });
            const match = runs.workflow_runs.find(r => r.head_sha === sha);
            if (!match) {
              core.setFailed(
                `No successful staging deployment found for SHA ${sha}. ` +
                `Deploy to staging first, or use skip_staging_check for emergencies.`
              );
            } else {
              core.info(`Staging verified: run #${match.run_number} deployed ${sha}`);
            }

      - name: Verify staging health (CI-triggered deploy)
        if: github.event_name == 'workflow_run'
        uses: actions/github-script@v8
        with:
          script: |
            // For CI-triggered deployments, exact SHA matching is not possible
            // since merge commits on main always have unique SHAs that won't
            // exist in staging deployments (which run on the develop branch).
            // Instead, verify that staging has been deployed recently.
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy-staging.yml',
              status: 'success',
              per_page: 5,
            });
            if (runs.workflow_runs.length === 0) {
              core.warning(
                'No staging deployments found. Staging environment may not be configured yet. ' +
                'Proceeding with production deployment since CI gate passed.'
              );
            } else {
              const latest = runs.workflow_runs[0];
              const deployedAt = new Date(latest.updated_at);
              const hoursAgo = Math.round((Date.now() - deployedAt.getTime()) / (1000 * 60 * 60));
              core.info(`Latest staging deployment: run #${latest.run_number} (${hoursAgo}h ago)`);
              if (hoursAgo > 168) {
                core.warning(`Staging deployment is ${hoursAgo}h old — consider deploying to staging first`);
              }
            }

      - name: Staging check skipped (emergency)
        if: github.event_name == 'workflow_dispatch' && inputs.skip_staging_check == true
        run: echo "::warning::Staging verification SKIPPED — emergency deployment"

  # ---------------------------------------------------------------------------
  # Deploy to production — requires manual approval via environment
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [verify-ci, verify-staging]
    environment:
      name: production
      url: https://greendrive.middleleap.com
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.verify-ci.outputs.deploy-sha }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Download build artifact from CI
        id: download-artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ needs.verify-ci.outputs.deploy-sha }}
          path: dist/
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true

      - name: Build frontend (fallback if artifact unavailable)
        if: steps.download-artifact.outcome != 'success'
        run: npm run build

      - name: Audit log — record deployment
        run: |
          echo "=== PRODUCTION DEPLOYMENT AUDIT ==="
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "Deployer:  ${{ github.actor }}"
          echo "Commit:    ${{ needs.verify-ci.outputs.deploy-sha }}"
          echo "Ref:       ${{ github.ref }}"
          echo "Run ID:    ${{ github.run_id }}"
          echo "Trigger:   ${{ github.event_name }}"
          echo "==================================="

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2.pem
          chmod 600 ~/.ssh/ec2.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Pre-deploy backup
        run: |
          ssh -i ~/.ssh/ec2.pem ec2-user@${{ secrets.EC2_HOST }} \
            "if [ -d ~/greendrive ]; then \
               BACKUP_DIR=~/backups/greendrive-\$(date +%Y%m%d-%H%M%S); \
               mkdir -p \$BACKUP_DIR; \
               rsync -a --exclude node_modules --exclude .git ~/greendrive/ \$BACKUP_DIR/; \
               cp ~/greendrive/data/greendrive.db \$BACKUP_DIR/greendrive.db.bak 2>/dev/null || true; \
               echo \"Full backup created: \$BACKUP_DIR\"; \
             fi"

      - name: Install production deps
        run: |
          rm -rf node_modules
          npm ci --omit=dev

      - name: Deploy via rsync
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '.env' \
            --exclude '.env.*' \
            --exclude '.DS_Store' \
            --exclude '*.log' \
            --exclude 'keys/' \
            --exclude 'data/' \
            -e "ssh -i ~/.ssh/ec2.pem" \
            ./ ec2-user@${{ secrets.EC2_HOST }}:~/greendrive/

      - name: Restart application
        run: |
          ssh -i ~/.ssh/ec2.pem ec2-user@${{ secrets.EC2_HOST }} \
            "cd ~/greendrive && \
             (pm2 reload ecosystem.config.cjs --env production || pm2 start ecosystem.config.cjs --env production)"

      - name: Post-deploy health check
        run: |
          MAX_RETRIES=6
          RETRY_INTERVAL=10
          for i in $(seq 1 $MAX_RETRIES); do
            STATUS=$(ssh -i ~/.ssh/ec2.pem ec2-user@${{ secrets.EC2_HOST }} \
              "curl -sf http://localhost:3001/ | node -e \"process.stdin.on('data',d=>{const j=JSON.parse(d);console.log(j.status)})\"" 2>/dev/null || echo "unreachable")
            if [ "$STATUS" = "ok" ]; then
              echo "Health check PASSED (attempt $i/$MAX_RETRIES)"
              exit 0
            fi
            echo "Health check attempt $i/$MAX_RETRIES: $STATUS — retrying in ${RETRY_INTERVAL}s..."
            sleep $RETRY_INTERVAL
          done
          echo "::error::Health check FAILED after $MAX_RETRIES attempts — consider rollback"
          exit 1

  # ---------------------------------------------------------------------------
  # Auto-rollback — restore previous deployment on health check failure
  # ---------------------------------------------------------------------------
  rollback:
    name: Auto-Rollback
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [deploy]
    if: always() && needs.deploy.result == 'failure'
    environment:
      name: production
    steps:
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2.pem
          chmod 600 ~/.ssh/ec2.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Restore from latest backup
        run: |
          ssh -i ~/.ssh/ec2.pem ec2-user@${{ secrets.EC2_HOST }} \
            "LATEST_BACKUP=\$(ls -td ~/backups/greendrive-* 2>/dev/null | head -1); \
             if [ -n \"\$LATEST_BACKUP\" ] && [ -d \"\$LATEST_BACKUP\" ]; then \
               echo \"Rolling back to: \$LATEST_BACKUP\"; \
               rsync -a --exclude node_modules --exclude data \
                 \"\$LATEST_BACKUP/\" ~/greendrive/; \
               cd ~/greendrive && pm2 reload ecosystem.config.cjs --env production; \
               echo 'Rollback complete'; \
             else \
               echo '::error::No backup found — manual intervention required'; \
               exit 1; \
             fi"

      - name: Verify rollback health
        run: |
          sleep 10
          STATUS=$(ssh -i ~/.ssh/ec2.pem ec2-user@${{ secrets.EC2_HOST }} \
            "curl -sf http://localhost:3001/ | node -e \"process.stdin.on('data',d=>{const j=JSON.parse(d);console.log(j.status)})\"" 2>/dev/null || echo "unreachable")
          if [ "$STATUS" = "ok" ]; then
            echo "Rollback health check PASSED"
          else
            echo "::error::Rollback health check FAILED — manual intervention required"
            exit 1
          fi

  # ---------------------------------------------------------------------------
  # Notify — deployment result, commit status, and optional Slack
  # ---------------------------------------------------------------------------
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    if: always()
    needs: [verify-ci, deploy, rollback]
    steps:
      - name: Report result
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "PRODUCTION DEPLOYMENT SUCCEEDED"
          elif [ "${{ needs.deploy.result }}" = "skipped" ]; then
            echo "::warning::DEPLOYMENT SKIPPED — prerequisite gate did not pass"
          elif [ "${{ needs.rollback.result }}" = "success" ]; then
            echo "::warning::DEPLOYMENT FAILED — AUTO-ROLLBACK SUCCEEDED"
          else
            echo "::error::DEPLOYMENT FAILED — ROLLBACK ALSO FAILED — MANUAL INTERVENTION REQUIRED"
          fi
          echo "Commit: ${{ needs.verify-ci.outputs.deploy-sha }}"
          echo "Deployed by: ${{ github.actor }}"

      - name: Create GitHub commit status
        uses: actions/github-script@v8
        with:
          script: |
            const deployResult = '${{ needs.deploy.result }}';
            const rollbackResult = '${{ needs.rollback.result }}';
            const sha = '${{ needs.verify-ci.outputs.deploy-sha }}';
            if (!sha) {
              core.info('No deploy SHA resolved — CI gate likely did not pass. Skipping commit status.');
              return;
            }
            let state, description;
            if (deployResult === 'success') {
              state = 'success';
              description = 'Production deployment succeeded';
            } else if (deployResult === 'skipped') {
              state = 'failure';
              description = 'Deployment skipped — prerequisite gate did not pass';
            } else if (rollbackResult === 'success') {
              state = 'failure';
              description = 'Deployment failed, auto-rollback succeeded';
            } else {
              state = 'failure';
              description = 'Deployment AND rollback failed — manual intervention needed';
            }
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: sha,
              state,
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              context: 'deploy/production',
              description,
            });

      - name: Slack notification (optional)
        run: |
          WEBHOOK="${{ secrets.SLACK_WEBHOOK_URL }}"
          if [ -z "$WEBHOOK" ]; then
            echo "No Slack webhook configured — skipping"
            exit 0
          fi
          DEPLOY_RESULT="${{ needs.deploy.result }}"
          ROLLBACK_RESULT="${{ needs.rollback.result }}"
          SHA="${{ needs.verify-ci.outputs.deploy-sha }}"
          SHORT_SHA="${SHA:0:7}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "$DEPLOY_RESULT" = "success" ]; then
            TEXT=":white_check_mark: Production deploy *succeeded* (\`${SHORT_SHA}\`)"
            COLOR="good"
          elif [ "$ROLLBACK_RESULT" = "success" ]; then
            TEXT=":warning: Production deploy *failed*, auto-rollback succeeded (\`${SHORT_SHA}\`)"
            COLOR="warning"
          else
            TEXT=":rotating_light: Production deploy AND rollback *FAILED* (\`${SHORT_SHA}\`) — manual intervention required"
            COLOR="danger"
          fi

          curl -sf -X POST "$WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"attachments\": [{
                \"color\": \"${COLOR}\",
                \"text\": \"${TEXT}\",
                \"fields\": [
                  {\"title\": \"Deployer\", \"value\": \"${{ github.actor }}\", \"short\": true},
                  {\"title\": \"Commit\", \"value\": \"<https://github.com/${{ github.repository }}/commit/${SHA}|\`${SHORT_SHA}\`>\", \"short\": true}
                ],
                \"actions\": [{\"type\": \"button\", \"text\": \"View Run\", \"url\": \"${RUN_URL}\"}]
              }]
            }" || echo "::warning::Slack notification failed"

      - name: Deployment summary
        if: always()
        run: |
          SHA="${{ needs.verify-ci.outputs.deploy-sha }}"
          echo "## Production Deployment Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "| Metric | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Commit | \`${SHA}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Deployer | ${{ github.actor }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Deploy Result | ${{ needs.deploy.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Rollback Result | ${{ needs.rollback.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Trigger | ${{ github.event_name }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Run | [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> "$GITHUB_STEP_SUMMARY"
