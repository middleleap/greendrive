# =============================================================================
# Bank GreenDrive — Production Deployment
# Requires: manual approval, CI gate passed, staging verified
# Bank-grade: approval gates, rollback support, audit logging
# =============================================================================

name: Deploy — Production

on:
  workflow_run:
    workflows: ['CI — Quality & Security Gates']
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      rollback_sha:
        description: 'Commit SHA to roll back to (leave empty for latest)'
        required: false
        type: string

permissions:
  contents: read

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  # ---------------------------------------------------------------------------
  # Gate check — CI must have passed
  # ---------------------------------------------------------------------------
  verify-ci:
    name: Verify CI Passed
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # For workflow_run: only proceed when CI succeeded
    # For workflow_dispatch: always run (API check happens in step below)
    if: >-
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    outputs:
      deploy-sha: ${{ steps.resolve-sha.outputs.sha }}
    steps:
      - name: Resolve deployment SHA
        id: resolve-sha
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "sha=${{ github.event.workflow_run.head_sha }}" >> "$GITHUB_OUTPUT"
            echo "CI Gate passed — deploying ${{ github.event.workflow_run.head_sha }}"
          else
            SHA="${{ inputs.rollback_sha }}"
            if [ -z "$SHA" ]; then
              SHA="${{ github.sha }}"
            fi
            echo "sha=$SHA" >> "$GITHUB_OUTPUT"
          fi

      - name: Verify CI Gate (manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const ref = '${{ steps.resolve-sha.outputs.sha }}';
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: ref,
              check_name: 'CI Gate',
            });
            const gate = checks.check_runs.find(c => c.name === 'CI Gate');
            if (!gate || gate.conclusion !== 'success') {
              core.setFailed('CI Gate has not passed for this ref — deployment blocked');
            }
            core.info(`CI Gate passed for ${ref}`);

  # ---------------------------------------------------------------------------
  # Deploy to production — requires manual approval via environment
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [verify-ci]
    environment:
      name: production
      url: https://greendrive.middleleap.com
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.verify-ci.outputs.deploy-sha }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Audit log — record deployment
        run: |
          echo "=== PRODUCTION DEPLOYMENT AUDIT ==="
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "Deployer:  ${{ github.actor }}"
          echo "Commit:    ${{ needs.verify-ci.outputs.deploy-sha }}"
          echo "Ref:       ${{ github.ref }}"
          echo "Run ID:    ${{ github.run_id }}"
          echo "Trigger:   ${{ github.event_name }}"
          echo "==================================="

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2.pem
          chmod 600 ~/.ssh/ec2.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Pre-deploy backup
        run: |
          ssh -i ~/.ssh/ec2.pem ec2-user@${{ secrets.EC2_HOST }} \
            "if [ -d ~/greendrive ]; then \
               BACKUP_DIR=~/backups/greendrive-\$(date +%Y%m%d-%H%M%S); \
               mkdir -p ~/backups; \
               cp -r ~/greendrive/dist \$BACKUP_DIR 2>/dev/null || true; \
               echo \"Backup created: \$BACKUP_DIR\"; \
             fi"

      - name: Deploy via rsync
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.env' \
            --exclude '.env.*' \
            --exclude '.DS_Store' \
            --exclude '*.log' \
            --exclude 'keys/' \
            -e "ssh -i ~/.ssh/ec2.pem" \
            ./ ec2-user@${{ secrets.EC2_HOST }}:~/greendrive/

      - name: Install production deps & restart
        run: |
          ssh -i ~/.ssh/ec2.pem ec2-user@${{ secrets.EC2_HOST }} \
            "cd ~/greendrive && \
             npm install --omit=dev && \
             (pm2 restart ecosystem.config.cjs --env production || pm2 start ecosystem.config.cjs --env production)"

      - name: Post-deploy health check
        run: |
          MAX_RETRIES=6
          RETRY_INTERVAL=10
          for i in $(seq 1 $MAX_RETRIES); do
            STATUS=$(ssh -i ~/.ssh/ec2.pem ec2-user@${{ secrets.EC2_HOST }} \
              "curl -sf http://localhost:3001/ | node -e \"process.stdin.on('data',d=>{const j=JSON.parse(d);console.log(j.status)})\"" 2>/dev/null || echo "unreachable")
            if [ "$STATUS" = "ok" ]; then
              echo "Health check PASSED (attempt $i/$MAX_RETRIES)"
              exit 0
            fi
            echo "Health check attempt $i/$MAX_RETRIES: $STATUS — retrying in ${RETRY_INTERVAL}s..."
            sleep $RETRY_INTERVAL
          done
          echo "::error::Health check FAILED after $MAX_RETRIES attempts — consider rollback"
          exit 1

  # ---------------------------------------------------------------------------
  # Auto-rollback — restore previous deployment on health check failure
  # ---------------------------------------------------------------------------
  rollback:
    name: Auto-Rollback
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [deploy]
    if: failure()
    environment:
      name: production
    steps:
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2.pem
          chmod 600 ~/.ssh/ec2.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Restore from latest backup
        run: |
          ssh -i ~/.ssh/ec2.pem ec2-user@${{ secrets.EC2_HOST }} \
            "LATEST_BACKUP=\$(ls -td ~/backups/greendrive-* 2>/dev/null | head -1); \
             if [ -n \"\$LATEST_BACKUP\" ] && [ -d \"\$LATEST_BACKUP\" ]; then \
               echo \"Rolling back to: \$LATEST_BACKUP\"; \
               rm -rf ~/greendrive/dist; \
               cp -r \"\$LATEST_BACKUP\" ~/greendrive/dist; \
               cd ~/greendrive && pm2 restart ecosystem.config.cjs --env production; \
               echo 'Rollback complete'; \
             else \
               echo '::error::No backup found — manual intervention required'; \
               exit 1; \
             fi"

      - name: Verify rollback health
        run: |
          sleep 10
          STATUS=$(ssh -i ~/.ssh/ec2.pem ec2-user@${{ secrets.EC2_HOST }} \
            "curl -sf http://localhost:3001/ | node -e \"process.stdin.on('data',d=>{const j=JSON.parse(d);console.log(j.status)})\"" 2>/dev/null || echo "unreachable")
          if [ "$STATUS" = "ok" ]; then
            echo "Rollback health check PASSED"
          else
            echo "::error::Rollback health check FAILED — manual intervention required"
            exit 1
          fi

  # ---------------------------------------------------------------------------
  # Notify — deployment result
  # ---------------------------------------------------------------------------
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    if: always()
    needs: [deploy, rollback]
    steps:
      - name: Report result
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "PRODUCTION DEPLOYMENT SUCCEEDED"
          elif [ "${{ needs.rollback.result }}" = "success" ]; then
            echo "::warning::DEPLOYMENT FAILED — AUTO-ROLLBACK SUCCEEDED"
          else
            echo "::error::DEPLOYMENT FAILED — ROLLBACK ALSO FAILED — MANUAL INTERVENTION REQUIRED"
          fi
          echo "Commit: ${{ github.event.workflow_run.head_sha || inputs.rollback_sha || github.sha }}"
          echo "Deployed by: ${{ github.actor }}"
